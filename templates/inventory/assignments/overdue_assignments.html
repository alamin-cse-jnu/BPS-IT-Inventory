{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}Overdue Assignments{% endblock %}

{% block extra_css %}
<style>
    .overdue-header {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
        border-radius: 8px;
    }
    .overdue-stats {
        border: 2px solid #dc3545;
        border-radius: 8px;
        background: rgba(220, 53, 69, 0.1);
    }
    .days-overdue {
        font-size: 1.1rem;
        font-weight: bold;
    }
    .critical-overdue {
        background: rgba(220, 53, 69, 0.2);
        border-left: 4px solid #dc3545;
    }
    .warning-overdue {
        background: rgba(255, 193, 7, 0.2);
        border-left: 4px solid #ffc107;
    }
    .recent-overdue {
        background: rgba(255, 193, 7, 0.1);
        border-left: 4px solid #fd7e14;
    }
    .action-buttons {
        white-space: nowrap;
    }
    .assignment-row:hover {
        background-color: #f8f9fc;
    }
    .priority-badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-exclamation-triangle text-danger"></i>
            Overdue Assignments
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'inventory:assignment_list' %}">Assignments</a></li>
                <li class="breadcrumb-item active">Overdue</li>
            </ol>
        </nav>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-xl-12">
            <div class="card shadow overdue-stats">
                <div class="card-header overdue-header py-3">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-chart-bar"></i>
                        Overdue Assignment Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="p-3">
                                <h2 class="text-danger font-weight-bold">{{ total_overdue }}</h2>
                                <p class="text-muted mb-0">Total Overdue</p>
                            </div>
                        </div>
                        <div class="col-md-3 border-left">
                            <div class="p-3">
                                <h2 class="text-danger font-weight-bold">
                                    {% for assignment in overdue_assignments %}
                                        {% if assignment.days_overdue >= 30 %}
                                            {% if forloop.first %}1{% else %}{{ forloop.counter }}{% endif %}
                                        {% endif %}
                                    {% empty %}0{% endfor %}
                                </h2>
                                <p class="text-muted mb-0">Critical (30+ days)</p>
                            </div>
                        </div>
                        <div class="col-md-3 border-left">
                            <div class="p-3">
                                <h2 class="text-warning font-weight-bold">
                                    {% for assignment in overdue_assignments %}
                                        {% if assignment.days_overdue >= 7 and assignment.days_overdue < 30 %}
                                            {% if forloop.first %}1{% else %}{{ forloop.counter }}{% endif %}
                                        {% endif %}
                                    {% empty %}0{% endfor %}
                                </h2>
                                <p class="text-muted mb-0">Warning (7-29 days)</p>
                            </div>
                        </div>
                        <div class="col-md-3 border-left">
                            <div class="p-3">
                                <h2 class="text-info font-weight-bold">
                                    {% for assignment in overdue_assignments %}
                                        {% if assignment.days_overdue < 7 %}
                                            {% if forloop.first %}1{% else %}{{ forloop.counter }}{% endif %}
                                        {% endif %}
                                    {% empty %}0{% endfor %}
                                </h2>
                                <p class="text-muted mb-0">Recent (1-6 days)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-tools"></i>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button class="btn btn-danger btn-sm btn-block mb-2" onclick="showBulkExtendModal()">
                                <i class="fas fa-calendar-plus"></i>
                                Bulk Extend
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-warning btn-sm btn-block mb-2" onclick="exportOverdueList()">
                                <i class="fas fa-file-export"></i>
                                Export List
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-info btn-sm btn-block mb-2" onclick="sendReminders()">
                                <i class="fas fa-envelope"></i>
                                Send Reminders
                            </button>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'inventory:assignment_list' %}" class="btn btn-secondary btn-sm btn-block mb-2">
                                <i class="fas fa-list"></i>
                                All Assignments
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overdue Assignments List -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Overdue Assignments Details
            </h6>
        </div>
        <div class="card-body">
            {% if overdue_assignments %}
                <div class="table-responsive">
                    <table class="table table-bordered" id="overdueTable">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="select-all" class="form-check-input">
                                </th>
                                <th>Priority</th>
                                <th>Assignment ID</th>
                                <th>Device</th>
                                <th>Assigned To</th>
                                <th>Expected Return</th>
                                <th>Days Overdue</th>
                                <th>Last Contact</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in overdue_assignments %}
                                <tr class="assignment-row 
                                    {% if assignment.days_overdue >= 30 %}critical-overdue
                                    {% elif assignment.days_overdue >= 7 %}warning-overdue
                                    {% else %}recent-overdue{% endif %}"
                                    data-assignment-id="{{ assignment.assignment_id }}">
                                    <td>
                                        <input type="checkbox" class="assignment-checkbox form-check-input" 
                                               value="{{ assignment.assignment_id }}">
                                    </td>
                                    <td>
                                        {% if assignment.days_overdue >= 30 %}
                                            <span class="badge badge-danger priority-badge">
                                                <i class="fas fa-exclamation-triangle"></i> Critical
                                            </span>
                                        {% elif assignment.days_overdue >= 7 %}
                                            <span class="badge badge-warning priority-badge">
                                                <i class="fas fa-exclamation"></i> Warning
                                            </span>
                                        {% else %}
                                            <span class="badge badge-info priority-badge">
                                                <i class="fas fa-clock"></i> Recent
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'inventory:assignment_detail' assignment.assignment_id %}" 
                                           class="font-weight-bold">
                                            {{ assignment.assignment_id }}
                                        </a>
                                    </td>
                                    <td>
                                        <a href="{% url 'inventory:device_detail' assignment.device.device_id %}" 
                                           class="text-primary">
                                            {{ assignment.device.device_id }}
                                        </a>
                                        <br>
                                        <small class="text-muted">{{ assignment.device.device_name }}</small>
                                    </td>
                                    <td>
                                        {% if assignment.assigned_to_staff %}
                                            <i class="fas fa-user text-primary"></i>
                                            <strong>{{ assignment.assigned_to_staff.user.get_full_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ assignment.assigned_to_staff.employee_id }}</small>
                                            {% if assignment.assigned_to_staff.email %}
                                                <br>
                                                <small class="text-muted">
                                                    <i class="fas fa-envelope"></i>
                                                    {{ assignment.assigned_to_staff.email }}
                                                </small>
                                            {% endif %}
                                        {% elif assignment.assigned_to_department %}
                                            <i class="fas fa-building text-info"></i>
                                            <strong>{{ assignment.assigned_to_department.name }}</strong>
                                        {% elif assignment.assigned_to_location %}
                                            <i class="fas fa-map-marker-alt text-success"></i>
                                            <strong>{{ assignment.assigned_to_location.name }}</strong>
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-danger font-weight-bold">
                                            {{ assignment.expected_return_date }}
                                        </span>
                                        <br>
                                        <small class="text-muted">
                                            {{ assignment.expected_return_date|timesince }} ago
                                        </small>
                                    </td>
                                    <td>
                                        <span class="days-overdue 
                                            {% if assignment.days_overdue >= 30 %}text-danger
                                            {% elif assignment.days_overdue >= 7 %}text-warning
                                            {% else %}text-info{% endif %}">
                                            {{ assignment.days_overdue }} day{{ assignment.days_overdue|pluralize }}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {% if assignment.last_contact_date %}
                                                {{ assignment.last_contact_date|timesince }} ago
                                            {% else %}
                                                No contact recorded
                                            {% endif %}
                                        </small>
                                    </td>
                                    <td class="action-buttons">
                                        <div class="btn-group-vertical btn-group-sm" role="group">
                                            <a href="{% url 'inventory:assignment_extend' assignment.assignment_id %}" 
                                               class="btn btn-warning btn-xs mb-1" title="Extend Assignment">
                                                <i class="fas fa-calendar-plus"></i>
                                            </a>
                                            <a href="{% url 'inventory:assignment_return' assignment.assignment_id %}" 
                                               class="btn btn-success btn-xs mb-1" title="Return Device">
                                                <i class="fas fa-undo-alt"></i>
                                            </a>
                                            <a href="{% url 'inventory:assignment_transfer' assignment.assignment_id %}" 
                                               class="btn btn-info btn-xs mb-1" title="Transfer Assignment">
                                                <i class="fas fa-exchange-alt"></i>
                                            </a>
                                            <button class="btn btn-secondary btn-xs" 
                                                    onclick="sendReminder('{{ assignment.assignment_id }}')" 
                                                    title="Send Reminder">
                                                <i class="fas fa-bell"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Selected Actions Bar -->
                <div class="row mt-3" id="selected-actions" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <strong id="selected-count">0</strong> assignment(s) selected
                                </div>
                                <div class="col-md-6 text-right">
                                    <button class="btn btn-warning btn-sm mr-2" onclick="bulkExtendSelected()">
                                        <i class="fas fa-calendar-plus"></i> Extend Selected
                                    </button>
                                    <button class="btn btn-info btn-sm mr-2" onclick="bulkReminderSelected()">
                                        <i class="fas fa-envelope"></i> Send Reminders
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="clearSelection()">
                                        <i class="fas fa-times"></i> Clear Selection
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h4 class="text-gray-800">No Overdue Assignments</h4>
                    <p class="text-gray-600">Great news! All assignments are current and on track.</p>
                    <a href="{% url 'inventory:assignment_list' %}" class="btn btn-primary">
                        <i class="fas fa-list"></i>
                        View All Assignments
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Statistics Charts -->
    {% if overdue_assignments %}
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Overdue by Priority</h6>
                </div>
                <div class="card-body">
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Overdue by Department</h6>
                </div>
                <div class="card-body">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Bulk Extend Modal -->
<div class="modal fade" id="bulkExtendModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus"></i>
                    Bulk Extend Assignments
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="bulk-extend-form">
                    <div class="form-group">
                        <label>Extension Days:</label>
                        <select class="form-control" id="extension-days">
                            <option value="7">7 Days</option>
                            <option value="14">14 Days</option>
                            <option value="30">30 Days</option>
                            <option value="custom">Custom...</option>
                        </select>
                    </div>
                    <div class="form-group" id="custom-days-group" style="display: none;">
                        <label>Custom Days:</label>
                        <input type="number" class="form-control" id="custom-days" min="1" max="365">
                    </div>
                    <div class="form-group">
                        <label>Extension Reason:</label>
                        <textarea class="form-control" id="bulk-reason" rows="3" required
                                  placeholder="Provide reason for bulk extension..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="processBulkExtend()">
                    <i class="fas fa-calendar-plus"></i>
                    Extend Assignments
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable with sorting and filtering
    $('#overdueTable').DataTable({
        "order": [[ 6, "desc" ]], // Sort by days overdue (descending)
        "pageLength": 25,
        "responsive": true,
        "columnDefs": [
            { "orderable": false, "targets": [0, 8] } // Disable sorting for checkbox and actions
        ]
    });

    // Select all checkbox functionality
    $('#select-all').change(function() {
        $('.assignment-checkbox').prop('checked', this.checked);
        updateSelectedActions();
    });

    // Individual checkbox functionality
    $('.assignment-checkbox').change(function() {
        updateSelectedActions();
        
        // Update select all checkbox
        const totalCheckboxes = $('.assignment-checkbox').length;
        const checkedCheckboxes = $('.assignment-checkbox:checked').length;
        $('#select-all').prop('checked', totalCheckboxes === checkedCheckboxes);
    });

    // Custom extension days
    $('#extension-days').change(function() {
        if ($(this).val() === 'custom') {
            $('#custom-days-group').show();
            $('#custom-days').attr('required', true);
        } else {
            $('#custom-days-group').hide();
            $('#custom-days').removeAttr('required');
        }
    });

    // Initialize charts if there are overdue assignments
    {% if overdue_assignments %}
    initializeCharts();
    {% endif %}
});

function updateSelectedActions() {
    const selectedCount = $('.assignment-checkbox:checked').length;
    $('#selected-count').text(selectedCount);
    
    if (selectedCount > 0) {
        $('#selected-actions').show();
    } else {
        $('#selected-actions').hide();
    }
}

function clearSelection() {
    $('.assignment-checkbox').prop('checked', false);
    $('#select-all').prop('checked', false);
    updateSelectedActions();
}

function showBulkExtendModal() {
    const selectedCount = $('.assignment-checkbox:checked').length;
    if (selectedCount === 0) {
        alert('Please select at least one assignment to extend.');
        return;
    }
    $('#bulkExtendModal').modal('show');
}

function bulkExtendSelected() {
    showBulkExtendModal();
}

function processBulkExtend() {
    const selectedIds = [];
    $('.assignment-checkbox:checked').each(function() {
        selectedIds.push($(this).val());
    });

    if (selectedIds.length === 0) {
        alert('No assignments selected.');
        return;
    }

    let days = $('#extension-days').val();
    if (days === 'custom') {
        days = $('#custom-days').val();
    }

    const reason = $('#bulk-reason').val().trim();
    if (!reason) {
        alert('Please provide a reason for the extension.');
        return;
    }

    // Here you would make an AJAX call to your bulk extend endpoint
    console.log('Extending assignments:', selectedIds, 'Days:', days, 'Reason:', reason);
    
    // Simulate success for demo
    $('#bulkExtendModal').modal('hide');
    alert(`Successfully extended ${selectedIds.length} assignments by ${days} days.`);
    location.reload();
}

function sendReminder(assignmentId) {
    if (confirm('Send reminder email for this assignment?')) {
        // AJAX call to send reminder
        console.log('Sending reminder for assignment:', assignmentId);
        alert('Reminder sent successfully.');
    }
}

function sendReminders() {
    const selectedIds = [];
    $('.assignment-checkbox:checked').each(function() {
        selectedIds.push($(this).val());
    });

    if (selectedIds.length === 0) {
        alert('Please select assignments to send reminders to.');
        return;
    }

    if (confirm(`Send reminder emails for ${selectedIds.length} assignment(s)?`)) {
        console.log('Sending reminders for assignments:', selectedIds);
        alert(`Reminders sent for ${selectedIds.length} assignments.`);
    }
}

function bulkReminderSelected() {
    sendReminders();
}

function exportOverdueList() {
    window.location.href = '/inventory/assignments/overdue/export/';
}

function initializeCharts() {
    // Priority Chart
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    new Chart(priorityCtx, {
        type: 'doughnut',
        data: {
            labels: ['Critical (30+)', 'Warning (7-29)', 'Recent (1-6)'],
            datasets: [{
                data: [
                    {{ overdue_assignments|length }}, // You'd calculate these properly in the view
                    0, // Placeholder values
                    0
                ],
                backgroundColor: ['#dc3545', '#ffc107', '#17a2b8']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Department Chart (if you have department data)
    const deptCtx = document.getElementById('departmentChart').getContext('2d');
    new Chart(deptCtx, {
        type: 'bar',
        data: {
            labels: ['IT', 'Finance', 'HR', 'Operations'], // Placeholder
            datasets: [{
                label: 'Overdue Assignments',
                data: [5, 3, 2, 4], // Placeholder
                backgroundColor: '#dc3545'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}