{% extends 'base.html' %}
{% load static %}

{% block title %}Bulk Actions{% endblock %}

{% block extra_css %}
<style>
.cascade-parent, .cascade-child {
    transition: all 0.3s ease;
}

.cascade-child:disabled {
    background-color: #f8f9fa;
    opacity: 0.7;
}

.action-fields {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    background-color: #f8f9fa;
    margin-top: 0.5rem;
}

.selected-devices-display {
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.location-preview {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.alert i {
    margin-right: 0.5rem;
}

.form-label i {
    width: 16px;
    text-align: center;
    margin-right: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">Bulk Actions</h1>
            <p class="text-muted">Perform actions on multiple items at once</p>
            <a href="{% url 'inventory:device_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Devices
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2 text-primary"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-import fa-2x text-primary mb-3"></i>
                                    <h6 class="card-title">Import Data</h6>
                                    <p class="card-text text-muted">Upload CSV/Excel files</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-export fa-2x text-primary mb-3"></i>
                                    <h6 class="card-title">Export Data</h6>
                                    <p class="card-text text-muted">Download reports</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-desktop fa-2x text-primary mb-3"></i>
                                    <h6 class="card-title">Assign Devices</h6>
                                    <p class="card-text text-muted">Bulk assignments</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-qrcode fa-2x text-primary mb-3"></i>
                                    <h6 class="card-title">QR Codes</h6>
                                    <p class="card-text text-muted">Generate labels</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2 text-primary"></i>Device Operations
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="deviceBulkForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Selected Devices</label>
                            <div class="selected-devices-display bg-light p-2 rounded">
                                <span id="deviceSelectedCount">No devices selected</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="actionType" class="form-label fw-semibold">Action Type</label>
                            <select id="actionType" name="action_type" class="form-select" required>
                                <option value="">Select action...</option>
                                <option value="update_status">Update Status</option>
                                <option value="update_condition">Update Condition</option>
                                <option value="update_location">Update Location</option>
                                <option value="update_category">Update Category</option>
                                <option value="schedule_maintenance">Schedule Maintenance</option>
                                <option value="retire_devices">Retire Devices</option>
                            </select>
                        </div>

                        <div id="actionFields">
                            <div id="statusFields" class="action Fields" style="display: none;">
                                <label for="newStatus" class="form-label">New Status</label>
                                <select id="newStatus" name="new_status" class="form-select">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="under_maintenance">Under Maintenance</option>
                                    <option value="retired">Retired</option>
                                </select>
                            </div>

                            <div id="conditionFields" class="action-fields" style="display: none;">
                                <label for="newCondition" class="form-label">New Condition</label>
                                <select id="newCondition" name="new_condition" class="form-select">
                                    <option value="excellent">Excellent</option>
                                    <option value="good">Good</option>
                                    <option value="fair">Fair</option>
                                    <option value="poor">Poor</option>
                                    <option value="damaged">Damaged</option>
                                </select>
                            </div>

                            <div id="locationFields" class="action-fields" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    Select new location hierarchy for selected devices
                                </div>
                                
                                <div class="mb-3">
                                    <label for="newLocationBuilding" class="form-label">
                                        <i class="fas fa-building"></i> Building
                                    </label>
                                    <select id="newLocationBuilding" name="new_location_building" class="form-select cascade-parent"
                                            data-cascade-target="newLocationBlock">
                                        <option value="">Select Building...</option>
                                        {% for building in buildings %}
                                            <option value="{{ building.id }}">{{ building.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="newLocationBlock" class="form-label">
                                        <i class="fas fa-th-large"></i> Block
                                    </label>
                                    <select id="newLocationBlock" name="new_location_block" class="form-select cascade-child"
                                            data-cascade-parent="newLocationBuilding"
                                            data-cascade-target="newLocationFloor"
                                            disabled>
                                        <option value="">Select Block...</option>
                                    </select>
                                    <small class="form-text text-muted">Choose a building first</small>
                                </div>

                                <div class="mb-3">
                                    <label for="newLocationFloor" class="form-label">
                                        <i class="fas fa-layer-group"></i> Floor
                                    </label>
                                    <select id="newLocationFloor" name="new_location_floor" class="form-select cascade-child"
                                            data-cascade-parent="newLocationBlock"
                                            data-cascade-target="newLocationDepartment"
                                            disabled>
                                        <option value="">Select Floor...</option>
                                    </select>
                                    <small class="form-text text-muted">Choose a block first</small>
                                </div>

                                <div class="mb-3">
                                    <label for="newLocationDepartment" class="form-label">
                                        <i class="fas fa-users"></i> Department
                                    </label>
                                    <select id="newLocationDepartment" name="new_location_department" class="form-select cascade-child"
                                            data-cascade-parent="newLocationFloor"
                                            data-cascade-target="newLocationRoom"
                                            disabled>
                                        <option value="">Select Department...</option>
                                    </select>
                                    <small class="form-text text-muted">Choose a floor first</small>
                                </div>

                                <div class="mb-3">
                                    <label for="newLocationRoom" class="form-label">
                                        <i class="fas fa-door-open"></i> Room <span class="text-muted">(Optional)</span>
                                    </label>
                                    <select id="newLocationRoom" name="new_location_room" class="form-select cascade-child"
                                            data-cascade-parent="newLocationDepartment"
                                            disabled>
                                        <option value="">Select Room (Optional)...</option>
                                    </select>
                                    <small class="form-text text-muted">Choose a department first</small>
                                </div>

                                <div class="mb-3" id="newLocationFinal" style="display: none;">
                                    <label for="newLocation" class="form-label">
                                        <i class="fas fa-map-marker-alt"></i> Final Location
                                    </label>
                                    <select id="newLocation" name="new_location" class="form-select">
                                        <option value="">Select Final Location...</option>
                                    </select>
                                </div>

                                <div class="alert alert-success" id="newLocationPreview" style="display: none;">
                                    <i class="fas fa-check-circle"></i>
                                    <strong>Selected Location:</strong>
                                    <span id="newLocationBreadcrumb"></span>
                                </div>
                            </div>

                            <div id="categoryFields" class="action-fields" style="display: none;">
                                <label for="newCategory" class="form-label">New Category</label>
                                <select id="newCategory" name="new_category" class="form-select">
                                    <option value="">Select category...</option>
                                    <option value="it_equipment">IT Equipment</option>
                                    <option value="furniture">Furniture</option>
                                    <option value="vehicles">Vehicles</option>
                                    <option value="office_supplies">Office Supplies</option>
                                </select>
                            </div>

                            <div id="maintenanceFields" class="action-fields" style="display: none;">
                                <div class="mb-3">
                                    <label for="maintenanceDate" class="form-label">Maintenance Date</label>
                                    <input type="date" id="maintenanceDate" name="maintenance_date" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="maintenanceType" class="form-label">Maintenance Type</label>
                                    <select id="maintenanceType" name="maintenance_type" class="form-select">
                                        <option value="preventive">Preventive</option>
                                        <option value="corrective">Corrective</option>
                                        <option value="emergency">Emergency</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="maintenanceNotes" class="form-label">Notes</label>
                                    <textarea id="maintenanceNotes" name="maintenance_notes" class="form-control" rows="4"></textarea>
                                </div>
                            </div>

                            <div id="retirementFields" class="action-fields" style="display: none;">
                                <div class="mb-3">
                                    <label for="retirementReason" class="form-label">Retirement Reason</label>
                                    <select id="retirementReason" name="retirement_reason" class="form-select">
                                        <option value="end_of_life">End of Life</option>
                                        <option value="damaged_beyond_repair">Damaged Beyond Repair</option>
                                        <option value="obsolete">Obsolete</option>
                                        <option value="lost">Lost</option>
                                        <option value="sold">Sold</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="retirementNotes" class="form-label">Notes</label>
                                    <textarea id="retirementNotes" name="retirement_notes" class="form-control" rows="4"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-play me-1"></i>Execute Action
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm('deviceBulkForm')">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-cog me-2 text-primary"></i>Assignment Operations
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="assignmentBulkForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Action Type</label>
                            <select id="assignmentActionType" name="action_type" class="form-select" required>
                                <option value="">Select action...</option>
                                <option value="bulk_assign">Bulk Assign Devices</option>
                                <option value="return_assignments">Return Assignments</option>
                                <option value="transfer_assignments">Transfer Assignments</option>
                                <option value="update_assignment_type">Update Assignment Type</option>
                            </select>
                        </div>

                        <div id="assignmentFields">
                            <div id="assignFields" class="action-fields" style="display: none;">
                                <div class="mb-3">
                                    <label for="assignToStaff" class="form-label">Assign to Staff</label>
                                    <select id="assignToStaff" name="assign_to_staff" class="form-select">
                                        <option value="">Select staff member...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="assignmentType" class="form-label">Assignment Type</label>
                                    <select id="assignmentType" name="assignment_type" class="form-select">
                                        <option value="temporary">Temporary</option>
                                        <option value="permanent">Permanent</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="assignmentDate" class="form-label">Assignment Date</label>
                                    <input type="date" id="assignmentDate" name="assignment_date" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="assignmentNotes" class="form-label">Notes</label>
                                    <textarea id="assignmentNotes" name="assignment_notes" class="form-control" rows="4"></textarea>
                                </div>
                            </div>

                            <div id="returnFields" class="action-fields" style="display: none;">
                                <div class="mb-3">
                                    <label for="returnAssignments" class="form-label">Select Assignments to Return</label>
                                    <select id="returnAssignments" name="return_assignments" class="form-select" multiple>
                                        <option value="">Select assignments...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="returnDate" class="form-label">Return Date</label>
                                    <input type="date" id="returnDate" name="return_date" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label for="returnCondition" class="form-label">Return Condition</label>
                                    <select id="returnCondition" name="return_condition" class="form-select">
                                        <option value="excellent">Excellent</option>
                                        <option value="good">Good</option>
                                        <option value="fair">Fair</option>
                                        <option value="poor">Poor</option>
                                        <option value="damaged">Damaged</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="returnNotes" class="form-label">Return Notes</label>
                                    <textarea id="returnNotes" name="return_notes" class="form-control" rows="4"></textarea>
                                </div>
                            </div>

                            <div id="transferFields" class="action-fields" style="display: none;">
                                <div class="mb-3">
                                    <label for="transferFrom" class="form-label">Transfer From</label>
                                    <select id="transferFrom" name="transfer_from" class="form-select">
                                        <option value="">Select current assignee...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="transferTo" class="form-label">Transfer To</label>
                                    <select id="transferTo" name="transfer_to" class="form-select">
                                        <option value="">Select new assignee...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="transferNotes" class="form-label">Transfer Notes</label>
                                    <textarea id="transferNotes" name="transfer_notes" class="form-control" rows="4"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-play me-1"></i>Execute Action
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm('assignmentBulkForm')">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map-marker-alt me-2 text-info"></i>Location Operations
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="locationBulkForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <input type="hidden" name="operation_type" value="location_operations">
                        
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Selected Devices</label>
                            <div class="selected-devices-display bg-light p-2 rounded">
                                <span id="locationSelectedCount">0 devices selected</span>
                                <small class="text-muted d-block">Select devices from the list above to perform location operations</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="locationActionType" class="form-label fw-semibold">Location Action</label>
                            <select id="locationActionType" name="location_action_type" class="form-select" required>
                                <option value="">Select action...</option>
                                <option value="move_to_location">Move to New Location</option>
                                <option value="swap_locations">Swap Device Locations</option>
                                <option value="clear_locations">Clear Current Locations</option>
                                <option value="audit_locations">Audit Current Locations</option>
                            </select>
                        </div>

                        <div id="locationActionFields" class="mb-3" style="display: none;">
                            <div id="moveLocationFields" class="action-fields" style="display: none;">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    This will move all selected devices to the new location
                                </div>
                                
                                <div class="mb-3">
                                    <label for="moveToBuilding" class="form-label">Building</label>
                                    <select id="moveToBuilding" name="move_to_building" class="form-select">
                                        <option value="">Select Building...</option>
                                        {% for building in buildings %}
                                            <option value="{{ building.id }}">{{ building.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="moveToBlock" class="form-label">Block</label>
                                    <select id="moveToBlock" name="move_to_block" class="form-select" disabled>
                                        <option value="">Select Block...</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="moveToFloor" class="form-label">Floor</label>
                                    <select id="moveToFloor" name="move_to_floor" class="form-select" disabled>
                                        <option value="">Select Floor...</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="moveToDepartment" class="form-label">Department</label>
                                    <select id="moveToDepartment" name="move_to_department" class="form-select" disabled>
                                        <option value="">Select Department...</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="moveToRoom" class="form-label">Room (Optional)</label>
                                    <select id="moveToRoom" name="move_to_room" class="form-select" disabled>
                                        <option value="">Select Room...</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="moveToLocation" class="form-label">Final Location</label>
                                    <select id="moveToLocation" name="move_to_location" class="form-select">
                                        <option value="">Select Final Location...</option>
                                    </select>
                                </div>
                            </div>

                            <div id="swapLocationFields" class="action-fields" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-exchange-alt"></i>
                                    Select two devices to swap their locations
                                </div>
                                <div class="mb-3">
                                    <label for="swapDevice1" class="form-label">Device 1</label>
                                    <select id="swapDevice1" name="swap_device_1" class="form-select">
                                        <option value="">Select first device...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="swapDevice2" class="form-label">Device 2</label>
                                    <select id="swapDevice2" name="swap_device_2" class="form-select">
                                        <option value="">Select second device...</option>
                                    </select>
                                </div>
                            </div>

                            <div id="clearLocationFields" class="action-fields" style="display: none;">
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    This will remove location information from all selected devices
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirmClearLocation" name="confirm_clear" required>
                                    <label class="form-check-label" for="confirmClearLocation">
                                        I confirm that I want to clear locations for selected devices
                                    </label>
                                </div>
                            </div>

                            <div id="auditLocationFields" class="action-fields" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-search"></i>
                                    Generate location audit report for selected devices
                                </div>
                                <div class="mb-3">
                                    <label for="auditReportType" class="form-label">Report Type</label>
                                    <select id="auditReportType" name="audit_report_type" class="form-select">
                                        <option value="current_status">Current Status Report</option>
                                        <option value="location_history">Location History Report</option>
                                        <option value="discrepancy_report">Discrepancy Report</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-info">
                                <i class="fas fa-play me-1"></i>Execute Location Action
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm('locationBulkForm')">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog me-2 text-primary"></i>Batch Processing
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-file-csv fa-2x text-primary mb-3"></i>
                                    <h6 class="card-title">CSV Import</h6>
                                    <p class="card-text">Import devices, staff, or assignments from CSV files</p>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary">Import</button>
                                        <a href="#" class="btn btn-outline-secondary">Download Template</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-file-excel fa-2x text-primary mb-3"></i>
                                    <h6 class="card-title">Excel Export</h6>
                                    <p class="card-text">Export reports and data to Excel format</p>
                                    <button class="btn btn-primary">Export</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <i class="fas fa-qrcode fa-2x text-primary mb-3"></i>
                                    <h6 class="card-title">Label Generation</h6>
                                    <p class="card-text">Generate QR codes and asset labels</p>
                                    <button class="btn btn-primary">Generate</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">Select Devices</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllDevices"></th>
                                <th>Device ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Device list will be populated dynamically -->
                        </tbody>
                    </table>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" onclick="cancelSelection()">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmDeviceSelection()">Select Devices</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">Select Assignments</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllAssignments"></th>
                                <th>Device</th>
                                <th>Assigned To</th>
                                <th>Assignment Date</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Assignment list will be populated dynamically -->
                        </tbody>
                    </table>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" onclick="cancelAssignmentSelection()">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmAssignmentSelection()">Select Assignments</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ================================
// LOCATION HIERARCHY CASCADE FOR BULK ACTIONS
// ================================

// Initialize location cascade for bulk actions
function initializeBulkLocationCascade() {
    // Main location update cascade
    setupLocationCascade('newLocation', 'newLocationBuilding', 'newLocationBlock', 'newLocationFloor', 'newLocationDepartment', 'newLocationRoom');
    
    // Move to location cascade
    setupLocationCascade('moveTo', 'moveToBuilding', 'moveToBlock', 'moveToFloor', 'moveToDepartment', 'moveToRoom');
}

// Setup location cascade for a specific prefix
function setupLocationCascade(prefix, buildingId, blockId, floorId, departmentId, roomId) {
    // Building change handler
    $(`#${buildingId}`).on('change', function() {
        const building = $(this).val();
        resetLocationCascade(prefix, 'block');
        
        if (building) {
            loadLocationOptions('{% url "inventory:ajax_get_blocks" %}', {building_id: building}, $(`#${blockId}`));
        }
        updateLocationBreadcrumb(prefix);
    });
    
    // Block change handler
    $(`#${blockId}`).on('change', function() {
        const block = $(this).val();
        resetLocationCascade(prefix, 'floor');
        
        if (block) {
            loadLocationOptions('{% url "inventory:ajax_get_floors" %}', {block_id: block}, $(`#${floorId}`));
        }
        updateLocationBreadcrumb(prefix);
    });
    
    // Floor change handler
    $(`#${floorId}`).on('change', function() {
        const floor = $(this).val();
        resetLocationCascade(prefix, 'department');
        
        if (floor) {
            loadLocationOptions('{% url "inventory:ajax_get_departments" %}', {floor_id: floor}, $(`#${departmentId}`));
        }
        updateLocationBreadcrumb(prefix);
    });
    
    // Department change handler
    $(`#${departmentId}`).on('change', function() {
        const department = $(this).val();
        resetLocationCascade(prefix, 'room');
        
        if (department) {
            loadLocationOptions('{% url "inventory:ajax_get_rooms" %}', {department_id: department}, $(`#${roomId}`));
            loadFinalLocations(prefix);
        }
        updateLocationBreadcrumb(prefix);
    });
    
    // Room change handler
    $(`#${roomId}`).on('change', function() {
        loadFinalLocations(prefix);
        updateLocationBreadcrumb(prefix);
    });
}

// Load location options via AJAX
function loadLocationOptions(url, params, targetSelect) {
    targetSelect.prop('disabled', true).html('<option value="">Loading...</option>');
    
    $.get(url, params)
        .done(function(data) {
            let options = '<option value="">Select...</option>';
            const dataKey = Object.keys(data)[0];
            
            data[dataKey].forEach(function(item) {
                const name = item.name || item.room_number;
                const code = item.code ? ` (${item.code})` : '';
                const floorNum = item.floor_number ? ` - Floor ${item.floor_number}` : '';
                options += `<option value="${item.id}">${name}${code}${floorNum}</option>`;
            });
            
            targetSelect.html(options).prop('disabled', false);
        })
        .fail(function() {
            targetSelect.html('<option value="">Error loading data</option>');
        });
}

// Reset location cascade from a specific level
function resetLocationCascade(prefix, fromLevel) {
    const levels = ['block', 'floor', 'department', 'room'];
    const startIndex = levels.indexOf(fromLevel);
    
    for (let i = startIndex; i < levels.length; i++) {
        const level = levels[i];
        $(`#${prefix}${level.charAt(0).toUpperCase()}${level.slice(1)}`).html('<option value="">Select...</option>').prop('disabled', true);
    }
    
    $(`#${prefix}Final`).hide();
    $(`#${prefix}Preview`).hide();
}

// Load final locations based on hierarchy
function loadFinalLocations(prefix) {
    const building = $(`#${prefix}Building`).val();
    const block = $(`#${prefix}Block`).val();
    const floor = $(`#${prefix}Floor`).val();
    const department = $(`#${prefix}Department`).val();
    const room = $(`#${prefix}Room`).val();
    
    if (department) {
        const params = {
            building_id: building,
            block_id: block,
            floor_id: floor,
            department_id: department,
            room_id: room || ''
        };
        
        $.get('{% url "inventory:ajax_location_search" %}', params)
            .done(function(data) {
                let options = '<option value="">Select Final Location...</option>';
                data.locations.forEach(function(location) {
                    options += `<option value="${location.id}">${location.display_text}</option>`;
                });
                
                $(`#${prefix}Location`).html(options);
                $(`#${prefix}Final`).show();
            });
    }
}

// Update location breadcrumb
function updateLocationBreadcrumb(prefix) {
    const parts = [];
    
    const building = $(`#${prefix}Building option:selected`).text();
    const block = $(`#${prefix}Block option:selected`).text();
    const floor = $(`#${prefix}Floor option:selected`).text();
    const department = $(`#${prefix}Department option:selected`).text();
    const room = $(`#${prefix}Room option:selected`).text();
    
    if (building && building !== 'Select Building...') parts.push(building);
    if (block && block !== 'Select...') parts.push(block);
    if (floor && block !== 'Select...') parts.push(floor);
    if (department && block !== 'Select...') parts.push(department);
    if (room && block !== 'Select...') parts.push(room);
    
    if (parts.length > 0) {
        $(`#${prefix}Breadcrumb`).text(parts.join(' â†’ '));
        $(`#${prefix}Preview`).show();
    } else {
        $(`#${prefix}Preview`).hide();
    }
}

// Location action type change handler
$('#locationActionType').on('change', function() {
    const actionType = $(this).val();
    const actionFields = $('#locationActionFields');
    const allFields = actionFields.find('.action-fields');
    
    allFields.hide();
    
    if (actionType) {
        actionFields.show();
        
        switch(actionType) {
            case 'move_to_location':
                $('#moveLocationFields').show();
                break;
            case 'swap_locations':
                $('#swapLocationFields').show();
                populateSwapDeviceOptions();
                break;
            case 'clear_locations':
                $('#clearLocationFields').show();
                break;
            case 'audit_locations':
                $('#auditLocationFields').show();
                break;
        }
    } else {
        actionFields.hide();
    }
});

// Populate swap device options with selected devices
function populateSwapDeviceOptions() {
    const selectedDevices = getSelectedDevices();
    let options = '<option value="">Select device...</option>';
    
    selectedDevices.forEach(function(device) {
        options += `<option value="${device.id}">${device.name}</option>`;
    });
    
    $('#swapDevice1, #swapDevice2').html(options);
}

// Initialize on document ready
$(document).ready(function() {
    initializeBulkLocationCascade();
});
</script>
{% endblock %}